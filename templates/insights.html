{% extends "base.html" %}

{% block content %}
<!-- Include Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Improved section spacing */
    .insights-section {
        margin-bottom: 40px;
    }

    .section-header {
        margin-bottom: 25px;
    }

    .section-header h3 {
        font-size: 1.3rem;
        color: #000000;
        margin-bottom: 6px;
        padding-bottom: 6px;
        border-bottom: 1px solid var(--border-color);
        transition: color 0.3s ease, border-color 0.3s ease;
    }

    [data-theme="dark"] .section-header h3 {
        color: #ffffff;
    }

    .section-header h4 {
        font-size: 1.1rem;
        color: #000000;
        margin-bottom: 4px;
        transition: color 0.3s ease;
    }

    [data-theme="dark"] .section-header h4 {
        color: #ffffff;
    }

    .section-header p {
        color: var(--text-secondary);
        margin-top: 0;
        transition: color 0.3s ease;
    }

    /* Chart container styling */
    .chart-container {
        background-color: var(--bg-secondary);
        border-radius: 12px;
        box-shadow: 0 4px 15px var(--shadow-color);
        padding: 20px;
        margin-bottom: 25px;
        height: 300px;
        position: relative;
        transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .chart-container:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px var(--shadow-color);
    }

    [data-theme="dark"] .chart-container {
        background-color: white;
    }

    /* Grid layout for charts */
    @media (min-width: 768px) {
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }
    }

    /* Compact layout for larger screens */
    @media (min-width: 1200px) {
        .insights-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    /* Chart section styling */
    .chart-section {
        margin-bottom: 15px;
    }

    /* Page header styling */
    .page-header {
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #000000;
        transition: border-color 0.3s ease;
    }

    [data-theme="dark"] .page-header {
        border-bottom: 2px solid #ffffff;
    }

    .page-header h2 {
        font-size: 1.7rem;
        color: #000000;
        margin-bottom: 8px;
        transition: color 0.3s ease;
    }

    [data-theme="dark"] .page-header h2 {
        color: #ffffff;
    }

    .page-header p {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin-top: 0;
        transition: color 0.3s ease;
    }

    [data-theme="dark"] .page-header p {
        color: var(--text-muted);
    }
</style>
<div class="insights-container">
    <div class="page-header">
        <h2>Business Insights</h2>
        <p>Analytics and performance metrics for your business</p>
    </div>

    <style>
        /* Enhanced stat cards */
        .stat-card {
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background-color: var(--bg-secondary);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #4e73df, #36b9cc);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 15px;
            display: inline-block;
            width: 60px;
            height: 60px;
            line-height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4e73df 0%, #36b9cc 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .stat-number, .stat-product {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #4e73df;
            text-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .stat-label {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-description {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.4;
            padding: 0 10px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        @media (min-width: 992px) {
            .stats-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-number">{{ sales_stats.total_sales }}</div>
            <div class="stat-label">Total Sales</div>
            <div class="stat-description">Number of completed orders</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <div class="stat-number">‚Çπ{{ sales_stats.total_revenue|round(2) }}</div>
            <div class="stat-label">Total Revenue</div>
            <div class="stat-description">Total revenue generated from all sales</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üì¶</div>
            <div class="stat-number">{{ sales_stats.total_products_sold }}</div>
            <div class="stat-label">Products Sold</div>
            <div class="stat-description">Total number of products sold</div>
        </div>

        {% if sales_stats.most_popular_product %}
        <div class="stat-card">
            <div class="stat-icon">üî•</div>
            <div class="stat-product">{{ sales_stats.most_popular_product }}</div>
            <div class="stat-label">Most Popular</div>
            <div class="stat-description">Sold {{ sales_stats.most_popular_quantity }} units</div>
        </div>
        {% endif %}
    </div>

    <!-- Key Performance Indicators -->
    <div class="insights-section">
        <div class="section-header">
            <h3>Key Performance Indicators</h3>
            <p>Financial metrics and business performance</p>
        </div>

        <div class="kpi-stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-number">‚Çπ{{ sales_stats.total_revenue|round(2) }}</div>
                <div class="stat-label">Total Revenue</div>
                <div class="stat-description">Total revenue generated from all sales</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üíº</div>
                <div class="stat-number">‚Çπ{{ sales_stats.total_inventory_investment|round(2) }}</div>
                <div class="stat-label">Inventory Investment</div>
                <div class="stat-description">Total value of current inventory at purchase price</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-number">‚Çπ{{ sales_stats.total_profit|round(2) }}</div>
                <div class="stat-label">Total Profit</div>
                <div class="stat-description">Total profit (revenue minus cost of goods sold)</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-number">{{ sales_stats.profit_margin|round(2) }}%</div>
                <div class="stat-label">Profit Margin</div>
                <div class="stat-description">Percentage of revenue that is profit</div>
            </div>
        </div>
    </div>

    <div class="insights-section">
        <div class="section-header">
            <h3>Inventory Overview</h3>
            <p>Current inventory status and metrics</p>
        </div>

        <div class="inventory-stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìã</div>
                <div class="stat-number">{{ items|length }}</div>
                <div class="stat-label">Products</div>
                <div class="stat-description">Total number of unique products available in our inventory</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üßÆ</div>
                <div class="stat-number">{{ total_inventory }}</div>
                <div class="stat-label">Total Inventory</div>
                <div class="stat-description">Total count of all items currently in stock</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üîã</div>
                <div class="stat-number">{{ categories }}</div>
                <div class="stat-label">Categories</div>
                <div class="stat-description">Different product categories available in our inventory</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-number">{{ low_stock_count }}</div>
                <div class="stat-label">Low Stock Items</div>
                <div class="stat-description">Items with quantity less than 5 units</div>
            </div>
        </div>
    </div>

    <style>
        .inventory-stats-grid, .kpi-stats-grid, .customer-stats-grid, .enquiry-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, auto);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (min-width: 992px) {
            .inventory-stats-grid, .kpi-stats-grid, .customer-stats-grid, .enquiry-stats-grid {
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: repeat(1, auto);
            }
        }

        @media (max-width: 768px) {
            .inventory-stats-grid, .kpi-stats-grid, .customer-stats-grid, .enquiry-stats-grid {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(4, auto);
            }
        }
    </style>

    <div class="insights-section">
        <div class="section-header">
            <h3>Low Stock Items</h3>
            <p>Items that need to be restocked soon</p>
        </div>

        <div class="low-stock-table-container">
            {% if low_stock_items %}
            <table class="low-stock-table data-table">
                <thead>
                    <tr>
                        <th>Item Code</th>
                        <th>Item Name</th>
                        <th>Current Quantity</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in low_stock_items %}
                    <tr>
                        <td>{{ item.item_code }}</td>
                        <td>{{ item.item_name }}</td>
                        <td class="quantity-cell {% if item.quantity <= 2 %}critical-stock{% elif item.quantity <= 5 %}low-stock{% endif %}">
                            {{ item.quantity }}
                        </td>
                        <td>
                            <a href="/stock" class="btn small-btn primary-btn">Manage</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="no-data-message">
                <p>No low stock items found. Your inventory is in good shape!</p>
            </div>
            {% endif %}
        </div>
    </div>

    <style>
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: var(--bg-secondary);
            box-shadow: 0 2px 10px var(--shadow-color);
            border-radius: 8px;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        [data-theme="dark"] .data-table {
            background-color: white;
        }

        .data-table th {
            background-color: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: color 0.3s ease, border-color 0.3s ease;
        }

        [data-theme="dark"] .data-table td {
            color: black;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background-color: var(--accent-tertiary);
        }

        .quantity-cell {
            font-weight: 600;
            text-align: center;
        }

        .low-stock {
            color: #ff9800;
        }

        .critical-stock {
            color: #f44336;
        }

        .primary-btn {
            background-color: #000000;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .primary-btn:hover {
            background-color: #333333;
        }

        [data-theme="dark"] .primary-btn {
            background-color: #ffffff;
            color: #000000;
        }

        [data-theme="dark"] .primary-btn:hover {
            background-color: #dddddd;
        }
    </style>

    <!-- Customer Insights Section -->
    <div class="insights-section">
        <div class="section-header">
            <h3>Customer Insights</h3>
            <p>Customer growth and payment analytics</p>
        </div>

        <div class="customer-stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-number">{{ customer_stats.total_customers }}</div>
                <div class="stat-label">Total Customers</div>
                <div class="stat-description">Total number of customers in the system</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üí∏</div>
                <div class="stat-number">‚Çπ{{ customer_stats.total_receivable|round(2) }}</div>
                <div class="stat-label">Total Receivable</div>
                <div class="stat-description">Total amount pending from customers</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-number">{{ customer_stats.fully_paid_percentage|round(1) }}%</div>
                <div class="stat-label">Fully Paid</div>
                <div class="stat-description">Percentage of customers with fully paid status</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üîÑ</div>
                <div class="stat-number">{{ customer_stats.new_customers_this_month }}</div>
                <div class="stat-label">New This Month</div>
                <div class="stat-description">New customers added in the current month</div>
            </div>
        </div>

        <div class="insights-grid">
            <!-- Customer Growth Chart -->
            <div class="chart-container">
                <canvas id="customerGrowthChart"></canvas>
            </div>

            <!-- Payment Status Distribution -->
            <div class="chart-container">
                <canvas id="paymentStatusChart"></canvas>
            </div>

            <!-- Customer Source Distribution -->
            <div class="chart-container">
                <canvas id="customerSourceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Enquiry Insights Section -->
    <div class="insights-section">
        <div class="section-header">
            <h3>Enquiry Analytics</h3>
            <p>Enquiry trends and conversion metrics</p>
        </div>

        <div class="enquiry-stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìù</div>
                <div class="stat-number">{{ enquiry_stats.total_enquiries }}</div>
                <div class="stat-label">Total Enquiries</div>
                <div class="stat-description">Total number of enquiries received</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-number">{{ enquiry_stats.conversion_rate|round(1) }}%</div>
                <div class="stat-label">Conversion Rate</div>
                <div class="stat-description">Percentage of enquiries converted to customers</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-number">{{ enquiry_stats.avg_response_time }}</div>
                <div class="stat-label">Avg. Response Time</div>
                <div class="stat-description">Average time to respond to enquiries</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üîç</div>
                <div class="stat-number">{{ enquiry_stats.open_enquiries }}</div>
                <div class="stat-label">Open Enquiries</div>
                <div class="stat-description">Enquiries that need follow-up</div>
            </div>
        </div>

        <div class="insights-grid">
            <!-- Enquiry Trend Chart -->
            <div class="chart-container">
                <canvas id="enquiryTrendChart"></canvas>
            </div>

            <!-- Enquiry Status Distribution -->
            <div class="chart-container">
                <canvas id="enquiryStatusChart"></canvas>
            </div>

            <!-- Enquiry to Customer Conversion -->
            <div class="chart-container">
                <canvas id="conversionRateChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Performers Section -->
    <div class="insights-section">
        <div class="section-header">
            <h3>Top Performers</h3>
            <p>Top buyers and best-selling products</p>
        </div>

        <div class="top-performers-grid">
            <!-- Top Buyers -->
            <div class="top-performers-card">
                <div class="section-header">
                    <h4>Top Buyers</h4>
                    <p>Customers with highest total purchases</p>
                </div>

                <div class="top-performers-list">
                    {% if sales_stats.top_buyers %}
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Total Purchases</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for buyer in sales_stats.top_buyers %}
                                <tr>
                                    <td>{{ buyer.name }}</td>
                                    <td class="amount-cell">‚Çπ{{ buyer.amount|round(2) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="no-data-message">
                            <p>No buyer data available.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Top Sellers -->
            <div class="top-performers-card">
                <div class="section-header">
                    <h4>Top Selling Products</h4>
                    <p>Products with highest revenue</p>
                </div>

                <div class="top-performers-list">
                    {% if sales_stats.top_sellers %}
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Total Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for seller in sales_stats.top_sellers %}
                                <tr>
                                    <td>{{ seller.name }}</td>
                                    <td class="amount-cell">‚Çπ{{ seller.revenue|round(2) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="no-data-message">
                            <p>No product sales data available.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="insights-section">
        <div class="section-header">
            <h3>Data Visualizations</h3>
            <p>Visual analytics of your business data</p>
        </div>

        <div class="insights-grid">
            <!-- Sales Trend Chart -->
            <div class="chart-section">
                <div class="section-header">
                    <h4>Sales Trend</h4>
                    <p>Sales performance over time</p>
                </div>

                <div class="chart-container">
                    <canvas id="salesTrendChart"></canvas>
                </div>
            </div>

            <!-- Product Category Distribution -->
            <div class="chart-section">
                <div class="section-header">
                    <h4>Product Category Distribution</h4>
                    <p>Breakdown of products by category</p>
                </div>

                <div class="chart-container">
                    <canvas id="categoryDistributionChart"></canvas>
                </div>
            </div>

            <!-- Revenue by Payment Method -->
            <div class="chart-section">
                <div class="section-header">
                    <h4>Revenue by Payment Method</h4>
                    <p>Revenue breakdown by payment method</p>
                </div>

                <div class="chart-container">
                    <canvas id="paymentMethodChart"></canvas>
                </div>
            </div>

            <!-- Inventory Value Distribution -->
            <div class="chart-section">
                <div class="section-header">
                    <h4>Inventory Value Distribution</h4>
                    <p>Value of inventory by category</p>
                </div>

                <div class="chart-container">
                    <canvas id="inventoryValueChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <style>
        .top-performers-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .top-performers-card {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
            padding: 15px;
            transition: background-color 0.3s ease;
        }

        [data-theme="dark"] .top-performers-card {
            background-color: white;
        }

        [data-theme="dark"] .top-performers-card .section-header h4 {
            color: black;
        }

        [data-theme="dark"] .top-performers-card .section-header p {
            color: rgba(0, 0, 0, 0.7);
        }

        .top-performers-list {
            margin-top: 15px;
        }

        .amount-cell {
            text-align: right;
            font-weight: 600;
            color: #000000;
            transition: color 0.3s ease;
        }

        [data-theme="dark"] .amount-cell {
            color: #000000;
        }

        .no-data-message {
            text-align: center;
            padding: 20px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            color: var(--text-secondary);
            font-style: italic;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        [data-theme="dark"] .no-data-message {
            background-color: white;
            color: black;
        }

        @media (max-width: 768px) {
            .top-performers-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- Recent Sales section removed as it's available in the Invoices page -->
</div>
<!-- Chart Initialization Scripts -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Using real data from the backend

        // Function to get theme-appropriate colors
        function getThemeColors() {
            const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
            return {
                backgroundColor: isDarkTheme ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)',
                borderColor: isDarkTheme ? 'rgba(255, 255, 255, 1)' : 'rgba(0, 0, 0, 1)',
                textColor: isDarkTheme ? 'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.8)',
                tooltipBackgroundColor: isDarkTheme ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.8)',
                tooltipTextColor: isDarkTheme ? 'rgba(255, 255, 255, 1)' : 'rgba(0, 0, 0, 1)'
            };
        }

        // Watch for theme changes
        const themeToggle = document.getElementById('theme-toggle-checkbox');
        if (themeToggle) {
            themeToggle.addEventListener('change', function() {
                // Update chart colors when theme changes
                setTimeout(updateChartColors, 100); // Small delay to ensure theme has changed
            });
        }

        // Sales Trend Chart
        const salesTrendCtx = document.getElementById('salesTrendChart').getContext('2d');
        const themeColors = getThemeColors();
        const salesTrendChart = new Chart(salesTrendCtx, {
            type: 'line',
            data: {
                labels: {{ sales_trend_labels|tojson }},
                datasets: [{
                    label: 'Sales (‚Çπ)',
                    data: {{ sales_trend_data|tojson }},
                    backgroundColor: themeColors.backgroundColor,
                    borderColor: themeColors.borderColor,
                    borderWidth: 2,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '‚Çπ' + value;
                            },
                            color: themeColors.textColor,
                            font: {
                                size: 9
                            }
                        },
                        grid: {
                            color: document.documentElement.getAttribute('data-theme') === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: themeColors.textColor,
                            font: {
                                size: 9
                            }
                        },
                        grid: {
                            color: document.documentElement.getAttribute('data-theme') === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: themeColors.textColor,
                            font: {
                                size: 10
                            },
                            boxWidth: 10,
                            padding: 5
                        }
                    },
                    tooltip: {
                        backgroundColor: themeColors.tooltipBackgroundColor,
                        titleColor: themeColors.tooltipTextColor,
                        bodyColor: themeColors.tooltipTextColor,
                        borderColor: themeColors.borderColor,
                        borderWidth: 1
                    }
                }
            }
        });

        // Product Category Distribution Chart
        const categoryDistributionCtx = document.getElementById('categoryDistributionChart').getContext('2d');
        const categoryDistributionChart = new Chart(categoryDistributionCtx, {
            type: 'pie',
            data: {
                labels: {{ category_distribution_labels|tojson }},
                datasets: [{
                    data: {{ category_distribution_data|tojson }},
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(201, 203, 207, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(201, 203, 207, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: themeColors.textColor,
                            font: {
                                size: 10
                            },
                            boxWidth: 10,
                            padding: 5
                        }
                    },
                    title: {
                        display: true,
                        text: 'Number of Products by Category',
                        color: themeColors.textColor,
                        font: {
                            size: 12
                        }
                    },
                    tooltip: {
                        backgroundColor: themeColors.tooltipBackgroundColor,
                        titleColor: themeColors.tooltipTextColor,
                        bodyColor: themeColors.tooltipTextColor,
                        borderColor: themeColors.borderColor,
                        borderWidth: 1
                    }
                }
            }
        });

        // Revenue by Payment Method Chart
        const paymentMethodCtx = document.getElementById('paymentMethodChart').getContext('2d');
        const paymentMethodChart = new Chart(paymentMethodCtx, {
            type: 'bar',
            data: {
                labels: {{ payment_method_labels|tojson }},
                datasets: [{
                    label: 'Revenue (‚Çπ)',
                    data: {{ payment_method_data|tojson }},
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '‚Çπ' + value;
                            },
                            color: themeColors.textColor,
                            font: {
                                size: 9
                            }
                        },
                        grid: {
                            color: document.documentElement.getAttribute('data-theme') === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: themeColors.textColor,
                            font: {
                                size: 9
                            }
                        },
                        grid: {
                            color: document.documentElement.getAttribute('data-theme') === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: themeColors.textColor,
                            font: {
                                size: 10
                            },
                            boxWidth: 10,
                            padding: 5
                        }
                    },
                    tooltip: {
                        backgroundColor: themeColors.tooltipBackgroundColor,
                        titleColor: themeColors.tooltipTextColor,
                        bodyColor: themeColors.tooltipTextColor,
                        borderColor: themeColors.borderColor,
                        borderWidth: 1
                    }
                }
            }
        });

        // Inventory Value Distribution Chart
        const inventoryValueCtx = document.getElementById('inventoryValueChart').getContext('2d');
        const inventoryValueChart = new Chart(inventoryValueCtx, {
            type: 'doughnut',
            data: {
                labels: {{ inventory_value_labels|tojson }},
                datasets: [{
                    data: {{ inventory_value_data|tojson }},
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(201, 203, 207, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(201, 203, 207, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: themeColors.textColor,
                            font: {
                                size: 10
                            },
                            boxWidth: 10,
                            padding: 5
                        }
                    },
                    title: {
                        display: true,
                        text: 'Inventory Value by Category (‚Çπ)',
                        color: themeColors.textColor,
                        font: {
                            size: 12
                        }
                    },
                    tooltip: {
                        backgroundColor: themeColors.tooltipBackgroundColor,
                        titleColor: themeColors.tooltipTextColor,
                        bodyColor: themeColors.tooltipTextColor,
                        borderColor: themeColors.borderColor,
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '‚Çπ' + context.raw;
                                return label;
                            }
                        }
                    }
                }
            }
        });
        // Function to update chart colors when theme changes
        function updateChartColors() {
            const themeColors = getThemeColors();

            // Update Sales Trend Chart
            if (salesTrendChart) {
                salesTrendChart.data.datasets[0].backgroundColor = themeColors.backgroundColor;
                salesTrendChart.data.datasets[0].borderColor = themeColors.borderColor;
                salesTrendChart.options.scales.y.ticks.color = themeColors.textColor;
                salesTrendChart.options.scales.x.ticks.color = themeColors.textColor;
                salesTrendChart.options.plugins.tooltip.backgroundColor = themeColors.tooltipBackgroundColor;
                salesTrendChart.options.plugins.tooltip.titleColor = themeColors.tooltipTextColor;
                salesTrendChart.options.plugins.tooltip.bodyColor = themeColors.tooltipTextColor;
                salesTrendChart.update();
            }

            // Update other charts as needed
            if (paymentMethodChart) {
                paymentMethodChart.options.scales.y.ticks.color = themeColors.textColor;
                paymentMethodChart.options.scales.x.ticks.color = themeColors.textColor;
                paymentMethodChart.options.plugins.tooltip.backgroundColor = themeColors.tooltipBackgroundColor;
                paymentMethodChart.options.plugins.tooltip.titleColor = themeColors.tooltipTextColor;
                paymentMethodChart.options.plugins.tooltip.bodyColor = themeColors.tooltipTextColor;
                paymentMethodChart.update();
            }

            if (categoryDistributionChart) {
                categoryDistributionChart.options.plugins.legend.labels.color = themeColors.textColor;
                categoryDistributionChart.options.plugins.title.color = themeColors.textColor;
                categoryDistributionChart.options.plugins.tooltip.backgroundColor = themeColors.tooltipBackgroundColor;
                categoryDistributionChart.options.plugins.tooltip.titleColor = themeColors.tooltipTextColor;
                categoryDistributionChart.options.plugins.tooltip.bodyColor = themeColors.tooltipTextColor;
                categoryDistributionChart.update();
            }

            if (inventoryValueChart) {
                inventoryValueChart.options.plugins.legend.labels.color = themeColors.textColor;
                inventoryValueChart.options.plugins.title.color = themeColors.textColor;
                inventoryValueChart.options.plugins.tooltip.backgroundColor = themeColors.tooltipBackgroundColor;
                inventoryValueChart.options.plugins.tooltip.titleColor = themeColors.tooltipTextColor;
                inventoryValueChart.options.plugins.tooltip.bodyColor = themeColors.tooltipTextColor;
                inventoryValueChart.update();
            }
        }

        // Customer Growth Chart
        const customerGrowthCtx = document.getElementById('customerGrowthChart').getContext('2d');
        const customerGrowthChart = new Chart(customerGrowthCtx, {
            type: 'line',
            data: {
                labels: {{ customer_growth_labels|tojson }},
                datasets: [{
                    label: 'New Customers',
                    data: {{ customer_growth_data|tojson }},
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                    pointBorderColor: '#fff',
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Customers',
                            color: themeColors.textColor
                        },
                        ticks: {
                            color: themeColors.textColor
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Month',
                            color: themeColors.textColor
                        },
                        ticks: {
                            color: themeColors.textColor
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Customer Growth Over Time',
                        color: themeColors.textColor,
                        font: {
                            size: 14
                        }
                    },
                    tooltip: {
                        backgroundColor: themeColors.tooltipBackgroundColor,
                        titleColor: themeColors.tooltipTextColor,
                        bodyColor: themeColors.tooltipTextColor
                    }
                }
            }
        });

        // Payment Status Distribution Chart
        const paymentStatusCtx = document.getElementById('paymentStatusChart').getContext('2d');
        const paymentStatusChart = new Chart(paymentStatusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Fully Paid', 'Partially Paid', 'Unpaid'],
                datasets: [{
                    data: [
                        {{ customer_stats.fully_paid_count }},
                        {{ customer_stats.partially_paid_count }},
                        {{ customer_stats.unpaid_count }}
                    ],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.7)',  // Green for Fully Paid
                        'rgba(255, 193, 7, 0.7)',  // Yellow for Partially Paid
                        'rgba(220, 53, 69, 0.7)'   // Red for Unpaid
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(220, 53, 69, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: themeColors.textColor,
                            font: {
                                size: 12
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Payment Status Distribution',
                        color: themeColors.textColor,
                        font: {
                            size: 14
                        }
                    },
                    tooltip: {
                        backgroundColor: themeColors.tooltipBackgroundColor,
                        titleColor: themeColors.tooltipTextColor,
                        bodyColor: themeColors.tooltipTextColor
                    }
                }
            }
        });

        // Customer Source Distribution Chart
        const customerSourceCtx = document.getElementById('customerSourceChart').getContext('2d');
        const customerSourceChart = new Chart(customerSourceCtx, {
            type: 'bar',
            data: {
                labels: {{ customer_source_labels|tojson }},
                datasets: [{
                    label: 'Number of Customers',
                    data: {{ customer_source_data|tojson }},
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Customers',
                            color: themeColors.textColor
                        },
                        ticks: {
                            color: themeColors.textColor
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Source',
                            color: themeColors.textColor
                        },
                        ticks: {
                            color: themeColors.textColor
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Customer Acquisition Channels',
                        color: themeColors.textColor,
                        font: {
                            size: 14
                        }
                    },
                    tooltip: {
                        backgroundColor: themeColors.tooltipBackgroundColor,
                        titleColor: themeColors.tooltipTextColor,
                        bodyColor: themeColors.tooltipTextColor
                    }
                }
            }
        });

        // Enquiry Trend Chart
        const enquiryTrendCtx = document.getElementById('enquiryTrendChart').getContext('2d');
        const enquiryTrendChart = new Chart(enquiryTrendCtx, {
            type: 'line',
            data: {
                labels: {{ enquiry_trend_labels|tojson }},
                datasets: [{
                    label: 'New Enquiries',
                    data: {{ enquiry_trend_data|tojson }},
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointBackgroundColor: 'rgba(153, 102, 255, 1)',
                    pointBorderColor: '#fff',
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Enquiries',
                            color: themeColors.textColor
                        },
                        ticks: {
                            color: themeColors.textColor
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Month',
                            color: themeColors.textColor
                        },
                        ticks: {
                            color: themeColors.textColor
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Enquiry Trend Over Time',
                        color: themeColors.textColor,
                        font: {
                            size: 14
                        }
                    },
                    tooltip: {
                        backgroundColor: themeColors.tooltipBackgroundColor,
                        titleColor: themeColors.tooltipTextColor,
                        bodyColor: themeColors.tooltipTextColor
                    }
                }
            }
        });

        // Enquiry Status Distribution Chart
        const enquiryStatusCtx = document.getElementById('enquiryStatusChart').getContext('2d');
        const enquiryStatusChart = new Chart(enquiryStatusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Open', 'In Progress', 'Converted', 'Closed'],
                datasets: [{
                    data: [
                        {{ enquiry_stats.open_count }},
                        {{ enquiry_stats.in_progress_count }},
                        {{ enquiry_stats.converted_count }},
                        {{ enquiry_stats.closed_count }}
                    ],
                    backgroundColor: [
                        'rgba(255, 193, 7, 0.7)',  // Yellow for Open
                        'rgba(54, 162, 235, 0.7)',  // Blue for In Progress
                        'rgba(40, 167, 69, 0.7)',   // Green for Converted
                        'rgba(108, 117, 125, 0.7)'  // Gray for Closed
                    ],
                    borderColor: [
                        'rgba(255, 193, 7, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(40, 167, 69, 1)',
                        'rgba(108, 117, 125, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: themeColors.textColor,
                            font: {
                                size: 12
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Enquiry Status Distribution',
                        color: themeColors.textColor,
                        font: {
                            size: 14
                        }
                    },
                    tooltip: {
                        backgroundColor: themeColors.tooltipBackgroundColor,
                        titleColor: themeColors.tooltipTextColor,
                        bodyColor: themeColors.tooltipTextColor
                    }
                }
            }
        });

        // Conversion Rate Chart
        const conversionRateCtx = document.getElementById('conversionRateChart').getContext('2d');
        const conversionRateChart = new Chart(conversionRateCtx, {
            type: 'bar',
            data: {
                labels: {{ conversion_rate_labels|tojson }},
                datasets: [{
                    label: 'Conversion Rate (%)',
                    data: {{ conversion_rate_data|tojson }},
                    backgroundColor: 'rgba(40, 167, 69, 0.7)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Conversion Rate (%)',
                            color: themeColors.textColor
                        },
                        ticks: {
                            color: themeColors.textColor
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Month',
                            color: themeColors.textColor
                        },
                        ticks: {
                            color: themeColors.textColor
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Enquiry to Customer Conversion Rate',
                        color: themeColors.textColor,
                        font: {
                            size: 14
                        }
                    },
                    tooltip: {
                        backgroundColor: themeColors.tooltipBackgroundColor,
                        titleColor: themeColors.tooltipTextColor,
                        bodyColor: themeColors.tooltipTextColor
                    }
                }
            }
        });

        // Initialize chart colors based on current theme
        updateChartColors();

        // Update the updateChartColors function to include our new charts
        function updateChartColors() {
            const themeColors = getThemeColors();

            // Update existing charts
            // ... (existing code)

            // Update Customer Growth Chart
            if (customerGrowthChart) {
                customerGrowthChart.options.scales.y.ticks.color = themeColors.textColor;
                customerGrowthChart.options.scales.x.ticks.color = themeColors.textColor;
                customerGrowthChart.options.scales.y.title.color = themeColors.textColor;
                customerGrowthChart.options.scales.x.title.color = themeColors.textColor;
                customerGrowthChart.options.plugins.title.color = themeColors.textColor;
                customerGrowthChart.options.plugins.tooltip.backgroundColor = themeColors.tooltipBackgroundColor;
                customerGrowthChart.options.plugins.tooltip.titleColor = themeColors.tooltipTextColor;
                customerGrowthChart.options.plugins.tooltip.bodyColor = themeColors.tooltipTextColor;
                customerGrowthChart.update();
            }

            // Update Payment Status Chart
            if (paymentStatusChart) {
                paymentStatusChart.options.plugins.legend.labels.color = themeColors.textColor;
                paymentStatusChart.options.plugins.title.color = themeColors.textColor;
                paymentStatusChart.options.plugins.tooltip.backgroundColor = themeColors.tooltipBackgroundColor;
                paymentStatusChart.options.plugins.tooltip.titleColor = themeColors.tooltipTextColor;
                paymentStatusChart.options.plugins.tooltip.bodyColor = themeColors.tooltipTextColor;
                paymentStatusChart.update();
            }

            // Update Customer Source Chart
            if (customerSourceChart) {
                customerSourceChart.options.scales.y.ticks.color = themeColors.textColor;
                customerSourceChart.options.scales.x.ticks.color = themeColors.textColor;
                customerSourceChart.options.scales.y.title.color = themeColors.textColor;
                customerSourceChart.options.scales.x.title.color = themeColors.textColor;
                customerSourceChart.options.plugins.title.color = themeColors.textColor;
                customerSourceChart.options.plugins.tooltip.backgroundColor = themeColors.tooltipBackgroundColor;
                customerSourceChart.options.plugins.tooltip.titleColor = themeColors.tooltipTextColor;
                customerSourceChart.options.plugins.tooltip.bodyColor = themeColors.tooltipTextColor;
                customerSourceChart.update();
            }

            // Update Enquiry Trend Chart
            if (enquiryTrendChart) {
                enquiryTrendChart.options.scales.y.ticks.color = themeColors.textColor;
                enquiryTrendChart.options.scales.x.ticks.color = themeColors.textColor;
                enquiryTrendChart.options.scales.y.title.color = themeColors.textColor;
                enquiryTrendChart.options.scales.x.title.color = themeColors.textColor;
                enquiryTrendChart.options.plugins.title.color = themeColors.textColor;
                enquiryTrendChart.options.plugins.tooltip.backgroundColor = themeColors.tooltipBackgroundColor;
                enquiryTrendChart.options.plugins.tooltip.titleColor = themeColors.tooltipTextColor;
                enquiryTrendChart.options.plugins.tooltip.bodyColor = themeColors.tooltipTextColor;
                enquiryTrendChart.update();
            }

            // Update Enquiry Status Chart
            if (enquiryStatusChart) {
                enquiryStatusChart.options.plugins.legend.labels.color = themeColors.textColor;
                enquiryStatusChart.options.plugins.title.color = themeColors.textColor;
                enquiryStatusChart.options.plugins.tooltip.backgroundColor = themeColors.tooltipBackgroundColor;
                enquiryStatusChart.options.plugins.tooltip.titleColor = themeColors.tooltipTextColor;
                enquiryStatusChart.options.plugins.tooltip.bodyColor = themeColors.tooltipTextColor;
                enquiryStatusChart.update();
            }

            // Update Conversion Rate Chart
            if (conversionRateChart) {
                conversionRateChart.options.scales.y.ticks.color = themeColors.textColor;
                conversionRateChart.options.scales.x.ticks.color = themeColors.textColor;
                conversionRateChart.options.scales.y.title.color = themeColors.textColor;
                conversionRateChart.options.scales.x.title.color = themeColors.textColor;
                conversionRateChart.options.plugins.title.color = themeColors.textColor;
                conversionRateChart.options.plugins.tooltip.backgroundColor = themeColors.tooltipBackgroundColor;
                conversionRateChart.options.plugins.tooltip.titleColor = themeColors.tooltipTextColor;
                conversionRateChart.options.plugins.tooltip.bodyColor = themeColors.tooltipTextColor;
                conversionRateChart.update();
            }
        }
    });
</script>
{% endblock %}
